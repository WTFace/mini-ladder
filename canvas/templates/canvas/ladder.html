{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" type="text/css" href="{% static 'canvas/main.css' %}">
<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
</head>
<body>
{% if res.REMOTE_ADDR in allowed %}
    <div class="logo"></div>
    <div id="container">
        <div id="result">
            <h3>지난회차</h3>
            {%for i in history %}
            <span class="result">
                <span class="num">{{i.id}}</span>
                
                {% if i.start == 'L' %}
                    <span class="res">좌</span>
                {% else %}
                    <span class="res r">우</span>
                {% endif %}
                {% if i.bridges == 4%}
                    <span class="res r">4</span>
                {% else %}
                    <span class="res">{{i.bridges}}</span>
                {% endif %}                

                {% if i.start == 'L' and i.bridges == 4 or i.start == 'R' and i.bridges == 3 %}
                    <span class="res">홀</span>
                {% else%}
                    <span class="res r">짝</span>
                {% endif%}
            </span>
            {%endfor%}
        </div>
        <span class="circle left"></span>
        <span class="circle right"></span>
        <span class="circle odd"></span>
        <span class="circle even"></span>
        <div class="progress-container">
            <div id="timer">
                <span></span>
            </div>
            <progress id="bar" value="0" max="180"></progress>
        </div>
    </div>
    

<script>
    let left_wall;
    let right_wall;
    let ball;
    let bridges = []
    const barColor = '#623D0B';
    const ballColor = 'yellow';
    const X = 95; const Y = 70;
    const radius = 18;
    const ballStart = 'L';
    const bridgeWidth = 130;
    const firstBridgeY = 112;

    const current = new Date();
    let val = (current.getMinutes()%3)*60+ current.getSeconds();


    function startGame(n, side) {
        bridges = [];
        myGameArea.clear();
        left_wall.update();right_wall.update();

        for (var i = 0; i < n; i++) {
            let _firstY = firstBridgeY;
            if(n===3) _firstY += radius;

            bridges.push(new component(bridgeWidth, radius, barColor, X+radius, _firstY+radius*i*2));
            bridges[i].update()
        }
        if (side === 'L') {
            ball = new component(radius, radius, ballColor, X, Y);
        }else{
            ball = new component(radius, radius, ballColor, X+radius+bridgeWidth, Y);
        }

        myGameArea.run();
    }

    let myGameArea = {
        canvas : document.createElement("canvas"),
        init: function(){
            this.canvas.width = 360;
            this.canvas.height = 360;
            this.context = this.canvas.getContext("2d");
            document.querySelector('#container').insertBefore(this.canvas, document.querySelector('#container').childNodes[1]);
            left_wall  = new component(radius, 225, barColor, X, Y);
            right_wall  = new component(radius, 225, barColor, X+radius+bridgeWidth, Y);
            left_wall.update();
            right_wall.update()
        },
        run : function() {
            this.interval = setInterval(updateGameArea, 15);
        },
        clear : function() {
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
        stop : function() {
            clearInterval(this.interval);
        }
    }

    function component(width, height, color, x, y) {
        this.width = width;
        this.height = height;
        this.speedX = 0;
        this.speedY = 1;    
        this.x = x;
        this.y = y;
        this.wasLeft = 0;
        if (x < 100) this.wasLeft = 1
        
        this.update = function() {
            ctx = myGameArea.context;
            ctx.fillStyle = color;
            ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.globalCompositeOperation='srouce-over';
        }
        this.crashRight = function(otherobj) {
            let myleft = this.x;
            let otherleft = otherobj.x;
            let crash = true;
            if (myleft < otherleft) {
                crash = false;
            }
            return crash
        }
        this.crashLeft = function(otherobj) {
            let myleft = this.x;
            let otherleft = otherobj.x;
            let crash = true;
            if (myleft > otherleft) {
                crash = false;
            }
            return crash
        }
        this.crashBridge = function(){
            let mytop = this.y;
            for(b of bridges){
                if(mytop === b.y) return true
            }
            return false
        }

    }

    function updateGameArea() {
        if ((ball.crashRight(right_wall) && ball.wasLeft===1) || (ball.crashLeft(left_wall)) && ball.wasLeft===0) {
            if(ball.speedX !==0 ) ball.y += 1
            if (ball.x>X+radius) {
                ball.wasLeft = 0
            }else{
                ball.wasLeft = 1
            }
            ball.speedY = 1
            ball.speedX = 0
        }
        
        // if ((ball.crashBot(bridge)|| ball.crashBot(bridge2) || ball.crashBot(bridge3)) && ball.speedY===1) {
        if (ball.crashBridge() && ball.speedY===1) {
            ball.speedY = 0
            if (ball.x>X+radius) {
                ball.speedX = -2
            }else{
                ball.speedX = 2
            }
            // console.log(`x:${ball.x}, speedX:${ball.speedX}, wasLeft:${ball.wasLeft}`)
        }
        if (ball.y > left_wall.y + left_wall.height-ball.height){
            myGameArea.stop();
            setTimeout(function(){
                location.reload()
            }, 4000)
        } 
        
        ball.update();
        ball.x += ball.speedX;
        ball.y += ball.speedY;    
    }

    let myVar = setInterval(refreshGame, 1000);

    function refreshGame() {
      let d = new Date();
      const id = '{{game_id}}'==480 ? 1 : parseInt('{{game_id}}')+1
      val += 1
      let secs = 180 - val;
      document.querySelector("#timer span").innerHTML = parseInt(secs/60)+'분 '+ secs%60+'초 후 '+ id +'회차 시작';
      document.querySelector("progress").value = val
      if (d.getMinutes()%3===0 && d.getSeconds()===0) {
        val = 0
        $.get(`/select/${id}`, function(res){
            const data = JSON.parse(res)
            console.log(data, id)
            startGame(data.bridges, data.start)
            $('.progress-container').toggle()
            // const start = data.start==='L'? '<span class="">좌</span>' : '<span class="res-r">우</span>';
            
            // let end = '<span class="res-r">짝</span>';
            // if ((data.start=='L' && data.bridges===4)||(data.start=='R' && data.bridges===3)) {
            //     end = '<span class="">홀</span>'
            // } 
            
            // let tr = document.createElement('tr');
            // tr.innerHTML = `<td>${id}</td><td>${start}</td><td>${data.bridges}</td><td>${end}</td>`
            // let tbody = document.getElementById('tbody')
            // tbody.insertBefore(tr, tbody.childNodes[0])
        })
      }
    }

    myGameArea.init();
</script>
{% else %}
    {{res.REMOTE_ADDR}}
    <li>HTTP_REFERER {{res.HTTP_REFERER}}</li>
{% endif %}
</body>
</html>