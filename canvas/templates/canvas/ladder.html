{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" type="text/css" href="{% static 'canvas/main.css' %}">

</head>
<body>
{% if res.REMOTE_ADDR in allowed %}
    <div id="container">
        <div id="result">result even odd</div>
    </div>
    <div class="progress-container">
        <progress id="bar" value="0" max="300000"></progress>
    </div>
    <div id="timer"></div>

<script>
    let left_wall;
    let right_wall;
    let ball;
    let bridges = []
    const X = 95; const Y = 70;
    const radius = 18;
    const ballStart = 'L';
    const bridgeWidth = 130;
    const firstBridgeY = 112;

    const current = new Date();
    let val = (current.getMinutes()%5)*60000;


    function startGame(n, side) {
        for (var i = 0; i < n; i++) {
            bridges.push(new component(bridgeWidth, radius, "skyblue", X+radius, firstBridgeY+radius*i*2));
            bridges[i].update()
        }
        if (side === 'L') {
            ball = new component(radius, radius, "red", X, Y);
        }else{
            ball = new component(radius, radius, "red", X+radius+bridgeWidth, Y);
        }

        myGameArea.run();
    }

    let myGameArea = {
        canvas : document.createElement("canvas"),
        init: function(){
            this.canvas.width = 360;
            this.canvas.height = 360;
            this.context = this.canvas.getContext("2d");
            document.querySelector('#container').insertBefore(this.canvas, document.querySelector('#container').childNodes[0]);
            left_wall  = new component(radius, 225, "skyblue", X, Y);
            right_wall  = new component(radius, 225, "skyblue", X+radius+bridgeWidth, Y);
            left_wall.update();
            right_wall.update()
        },
        run : function() {
            this.interval = setInterval(updateGameArea, 15);
        },
        clear : function() {
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
        stop : function() {
            clearInterval(this.interval);
        }
    }

    function component(width, height, color, x, y) {
        this.width = width;
        this.height = height;
        this.speedX = 0;
        this.speedY = 1;    
        this.x = x;
        this.y = y;
        this.wasLeft = 0;
        if (x < 100) this.wasLeft = 1
        
        this.update = function() {
            ctx = myGameArea.context;
            ctx.fillStyle = color;
            ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.globalCompositeOperation='srouce-over';
        }
        this.crashRight = function(otherobj) {
            let myleft = this.x;
            let otherleft = otherobj.x;
            let crash = true;
            if (myleft < otherleft) {
                crash = false;
            }
            return crash
        }
        this.crashLeft = function(otherobj) {
            let myleft = this.x;
            let otherleft = otherobj.x;
            let crash = true;
            if (myleft > otherleft) {
                crash = false;
            }
            return crash
        }
        this.crashBot = function(otherobj) {
            let mytop = this.y;
            let othertop = otherobj.y;
            let crash = true;
            if (mytop !== othertop) {
                crash = false;
            }
            return crash
        }
        this.crashBridge = function(){
            let mytop = this.y;
            for(b of bridges){
                if(mytop === b.y) return true
            }
            return false
        }

    }

    function updateGameArea() {
        if ((ball.crashRight(right_wall) && ball.wasLeft===1) || (ball.crashLeft(left_wall)) && ball.wasLeft===0) {
            if(ball.speedX !==0 ) ball.y += 1
            if (ball.x>X+radius) {
                ball.wasLeft = 0
            }else{
                ball.wasLeft = 1
            }
            ball.speedY = 1
            ball.speedX = 0
        }
        
        // if ((ball.crashBot(bridge)|| ball.crashBot(bridge2) || ball.crashBot(bridge3)) && ball.speedY===1) {
        if (ball.crashBridge() && ball.speedY===1) {
            ball.speedY = 0
            if (ball.x>X+radius) {
                ball.speedX = -2
            }else{
                ball.speedX = 2
            }
            console.log(`x:${ball.x}, speedX:${ball.speedX}, wasLeft:${ball.wasLeft}`)
        }
        if (ball.y > left_wall.y + left_wall.height-ball.height) myGameArea.stop()
        // myGameArea.clear();
        ball.update();
        ball.x += ball.speedX;
        ball.y += ball.speedY;    
    }

    let myVar = setInterval(refreshGame, 1000);

    function refreshGame() {
      let d = new Date();
      document.getElementById("timer").innerHTML = d.toLocaleTimeString() + ' (5분마다 시작)';
      val += 1000
      document.querySelector("progress").value = val
      if (d.getMinutes()%5===0 && d.getSeconds()===0) {
        val = 0
        startGame(4,'L')
      }
    }
    myGameArea.init();
    // startGame(4, 'R')
</script>
{% else %}
    {{res.REMOTE_ADDR}}
{% endif %}
</body>
</html>